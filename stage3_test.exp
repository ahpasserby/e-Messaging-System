#!/usr/bin/expect -f

# 启用实时输出
log_user 1
set timeout 10

# 获取今天的日期
set today [exec date +%d/%m/%Y]
puts "今天的日期: $today"

# 设置全局错误处理：任何expect超时都会导致脚本退出
expect_before timeout {
    puts "\n❌ 测试失败: 等待超时，预期输出不匹配"
    puts "最后看到的输出: $expect_out(buffer)"
    exit 1
}

# 清理旧文件，但保留users.txt（因为stage1已经创建了用户）
exec rm -f friends.txt messages.txt

puts "\n=== Stage3测试: 消息管理 ==="
puts "=== 注意: 需要先重新建立好友关系 ===\n"

puts "=== 步骤1: 重新建立好友关系（Cindy, Emily, James, Sophia互为好友） ===\n"

# 1. 首先，每个用户都向其他所有用户发送好友请求
# Cindy向Emily、James、Sophia发送请求
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Cindy\r"
expect "and password: "
send "4567A8\r"
expect "Login successful. Welcome Cindy!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "1\r"
expect "Enter usernames to add (in one line separated by space): "
send "Emily James Sophia\r"
expect "Friend request sent to Emily."
expect "Friend request sent to James."
expect "Friend request sent to Sophia."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# Emily向James和Sophia发送请求（Cindy已经向Emily发送了请求）
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Emily\r"
expect "and password: "
send "e9M2xQ\r"
expect "Login successful. Welcome Emily!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "1\r"
expect "Enter usernames to add (in one line separated by space): "
send "James Sophia\r"
expect "Friend request sent to James."
expect "Friend request sent to Sophia."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# James向Sophia发送请求（Cindy和Emily已经向James发送了请求）
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "1\r"
expect "Enter usernames to add (in one line separated by space): "
send "Sophia\r"
expect "Friend request sent to Sophia."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 2. 然后，每个用户都接受所有待确认的好友请求
# Emily接受Cindy的请求
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Emily\r"
expect "and password: "
send "e9M2xQ\r"
expect "Login successful. Welcome Emily!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "2\r"
expect "Pending friend requests for Emily:"
expect "1. Cindy"
expect "2. All"
expect "3. Back"
expect "Enter indices (space separated), press Enter to finish: "
send "2\r"
expect "Friend requests updated for all."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# James接受Cindy和Emily的请求
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "2\r"
expect "Pending friend requests for James:"
expect "1. Cindy"
expect "2. Emily"
expect "3. All"
expect "4. Back"
expect "Enter indices (space separated), press Enter to finish: "
send "3\r"
expect "Friend requests updated for all."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# Sophia接受Cindy、Emily和James的请求
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Sophia\r"
expect "and password: "
send "s5Rf@v\r"
expect "Login successful. Welcome Sophia!"
expect "Choose an option (1-3): "
send "1\r"
expect "Choose an option (1-5): "
send "2\r"
expect "Pending friend requests for Sophia:"
expect "1. Cindy"
expect "2. Emily"
expect "3. James"
expect "4. All"
expect "5. Back"
expect "Enter indices (space separated), press Enter to finish: "
send "4\r"
expect "Friend requests updated for all."
expect "Choose an option (1-5): "
send "5\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "=== 步骤2: 消息管理测试 ==="

puts "=== 测试1: 当用户没有消息时读取/删除消息 ==="

# 测试1: James登录并检查没有消息的情况
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "No messages found."
expect "Choose an option (1-4): "
send "3\r"
expect "No messages found."
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "=== 测试2: 发送和读取消息（James和Cindy之间） ==="

# 测试2.1: James发送消息给Cindy
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Hi Cindy, are we still meeting for lunch tomorrow?\r"
expect "Your friends:"
expect "1. Cindy"
expect "2. Emily"
expect "3. Sophia"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "1\r"
expect "Message sent to Cindy"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试2.2: Cindy读取消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Cindy\r"
expect "and password: "
send "4567A8\r"
expect "Login successful. Welcome Cindy!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: James"
expect "Hi Cindy, are we still meeting for lunch tomorrow?"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "Found no messages."
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: James"
expect "Hi Cindy, are we still meeting for lunch tomorrow?"
expect "Choose an option (1-4): "

# 测试2.3: Cindy回复消息给James
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Yes, 12:30 at the usual place?\r"
expect "Your friends:"
expect "1. Emily"
expect "2. James"
expect "3. Sophia"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "2\r"
expect "Message sent to James"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试2.4: James读取Cindy的回复
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Cindy"
expect "Yes, 12:30 at the usual place?"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "=== 测试3: 发送消息给选定的好友（Emily发送给Cindy和Sophia） ==="

# 测试3.1: Emily发送消息给Cindy和Sophia
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Emily\r"
expect "and password: "
send "e9M2xQ\r"
expect "Login successful. Welcome Emily!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Emergency meeting in 10 minutes!\r"
expect "Your friends:"
expect "1. Cindy"
expect "2. James"
expect "3. Sophia"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "1 3\r"
expect "Message sent to Cindy"
expect "Message sent to Sophia"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试3.2: Cindy读取Emily的消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Cindy\r"
expect "and password: "
send "4567A8\r"
expect "Login successful. Welcome Cindy!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "Found no messages."
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: James"
expect "Hi Cindy, are we still meeting for lunch tomorrow?"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试3.3: Sophia读取Emily的消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Sophia\r"
expect "and password: "
send "s5Rf@v\r"
expect "Login successful. Welcome Sophia!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "Found no messages."
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "=== 测试4: 发送消息给所有好友 ==="

# 测试4.1: Emily发送消息给所有好友
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Emily\r"
expect "and password: "
send "e9M2xQ\r"
expect "Login successful. Welcome Emily!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Emergency meeting in 5 minutes!\r"
expect "Your friends:"
expect "1. Cindy"
expect "2. James"
expect "3. Sophia"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "4\r"
expect "Message sent to All"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试4.2: Cindy读取Emily的"Emergency meeting in 5 minutes!"消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Cindy\r"
expect "and password: "
send "4567A8\r"
expect "Login successful. Welcome Cindy!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: James"
expect "Hi Cindy, are we still meeting for lunch tomorrow?"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试4.3: James读取Emily的"Emergency meeting in 5 minutes!"消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: Cindy"
expect "Yes, 12:30 at the usual place?"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试4.4: Sophia读取Emily的"Emergency meeting in 5 minutes!"消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Sophia\r"
expect "and password: "
send "s5Rf@v\r"
expect "Login successful. Welcome Sophia!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "=== 测试5: 不同用户之间发送消息 ==="

# 测试5.1: Sophia发送消息给Emily
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Sophia\r"
expect "and password: "
send "s5Rf@v\r"
expect "Login successful. Welcome Sophia!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Running late, save me a seat\r"
expect "Your friends:"
expect "1. Cindy"
expect "2. Emily"
expect "3. James"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "2\r"
expect "Message sent to Emily"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试5.2: James发送消息给Sophia
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "James\r"
expect "and password: "
send "j8#Kp3\r"
expect "Login successful. Welcome James!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "1\r"
expect "Enter message (max 255 chars), press Enter to finish: "
send "Can you review my presentation?\r"
expect "Your friends:"
expect "1. Cindy"
expect "2. Emily"
expect "3. Sophia"
expect "4. All"
expect "5. Back"
expect "Enter friend numbers (separated by space), press Enter to finish: "
send "3\r"
expect "Message sent to Sophia"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试5.3: Emily读取Sophia的消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Emily\r"
expect "and password: "
send "e9M2xQ\r"
expect "Login successful. Welcome Emily!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: Sophia"
expect "Running late, save me a seat"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: Sophia"
expect "Running late, save me a seat"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

# 测试5.4: Sophia读取James的消息
spawn ./messaging_system
expect "Choose an option (1-3): "
send "1\r"
expect "Please input your account name: "
send "Sophia\r"
expect "and password: "
send "s5Rf@v\r"
expect "Login successful. Welcome Sophia!"
expect "Choose an option (1-3): "
send "2\r"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "2\r"
expect "From: James"
expect "Can you review my presentation?"
expect "Choose an option (1-4): "
send "2\r"
expect "1. Read all messages"
expect "2. Read unread messages only"
expect "3. Back"
expect "Choose an option: "
send "1\r"
expect "From: Emily"
expect "Emergency meeting in 10 minutes!"
expect "From: Emily"
expect "Emergency meeting in 5 minutes!"
expect "From: James"
expect "Can you review my presentation?"
expect "Choose an option (1-4): "
send "4\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Choose an option (1-3): "
send "3\r"
expect "Byebye"
expect eof

puts "\n=== Stage3测试完成 ==="
puts "=== 此时应生成所有消息文件，可以手动打包为stage3.zip ==="
